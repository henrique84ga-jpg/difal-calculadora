<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulador DIFAL SP ‚Äì Vers√£o Final</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style id="main-styles">
:root { --primary: #1a3b5c; --secondary: #3b82f6; --text: #334155; --bg: #f8fafc; --border: #e2e8f0; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 30px; margin: 0; }
.container { max-width: 1600px; margin: 0 auto; }

/* Header */
header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
h2 { color: var(--primary); margin: 0; font-size: 24px; }
.badge { background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 600; }

/* Upload Area */
.upload-area { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 20px; text-align: center; background: #fff; cursor: pointer; transition: all 0.2s; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.upload-area:hover { border-color: var(--secondary); background: #eff6ff; }
/* Input real escondido */
#xmlFile { display: none; }

/* Bot√µes e Pain√©is */
.btn-preview { background: #fff; border: 1px solid var(--primary); color: var(--primary); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; display: none; align-items: center; gap: 8px; margin-left: auto; }
.btn-preview:hover { background: #f1f5f9; }

/* Info Header */
.info-card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; display: none; border-left: 5px solid var(--primary); }
.info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
.info-item label { display: block; font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
.info-item span { font-size: 15px; font-weight: 600; color: var(--primary); display: block; }
.info-divider { height: 1px; background: #e2e8f0; margin: 15px 0; grid-column: 1 / -1; }

/* Tabela */
.table-container { background: #fff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 20px; display: none; }
table { width: 100%; border-collapse: collapse; min-width: 1200px; }
th { background: var(--primary); color: #fff; padding: 10px; font-size: 12px; text-align: right; }
th:first-child, td:first-child { text-align: center; }
td { padding: 6px 10px; border-bottom: 1px solid var(--border); font-size: 12px; text-align: right; }
td.left { text-align: left; }
.input-cell input { width: 100%; text-align: right; border: 1px solid transparent; background: transparent; font-family: inherit; font-size: 12px; }
.input-cell input:focus { border-bottom: 1px solid var(--secondary); outline: none; background: #fff; }
.bg-edit { background-color: #fffbeb; }
.bg-res { background-color: #f0fdf4; font-weight: 700; color: #166534; }

/* Footer */
.actions-bar { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px 25px; border-radius: 12px; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); position: sticky; bottom: 20px; display: none; z-index: 10; }
.total-box { font-size: 18px; font-weight: 700; color: var(--primary); }
.btn-group { display: flex; gap: 10px; }
button.action-btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: #fff; }
.btn-pdf { background: #ef4444; }
.btn-excel { background: #10b981; }

/* Modal DANFE */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
.modal-content { background: #fff; width: 90%; max-width: 1000px; height: 90%; border-radius: 8px; overflow-y: auto; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
.modal-header { background: #e2e8f0; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #cbd5e1; position: sticky; top: 0; }
.close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; }
.danfe-wrapper { padding: 20px; font-family: 'Arial', sans-serif; color: #000; background: #fff; }
.danfe-box { border: 1px solid #000; margin-bottom: 5px; font-size: 10px; position: relative; }
.danfe-row { display: flex; border-bottom: 1px solid #000; }
.danfe-row:last-child { border-bottom: none; }
.danfe-col { flex: 1; border-right: 1px solid #000; padding: 4px; display: flex; flex-direction: column; }
.danfe-col:last-child { border-right: none; }
.danfe-col-2 { flex: 2; } .danfe-col-3 { flex: 3; } .danfe-col-4 { flex: 4; }
.danfe-label { font-size: 8px; font-weight: bold; text-transform: uppercase; margin-bottom: 2px; }
.danfe-val { font-size: 11px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.danfe-title { font-size: 14px; font-weight: bold; text-align: center; margin: 10px 0; background: #eee; border: 1px solid #000; padding: 2px; }
.danfe-table { width: 100%; border-collapse: collapse; font-size: 9px; }
.danfe-table th { background: #ccc; border: 1px solid #000; color: #000; font-weight: bold; text-align: center; padding: 2px; }
.danfe-table td { border: 1px solid #000; padding: 2px; }
.danfe-table .num { text-align: right; }
.xml-rule-active { color: red; font-weight: bold; }
</style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h2>Simulador DIFAL SP</h2>
            <span class="badge">Base Dupla (Por Dentro)</span>
        </div>
        <button id="btnPreview" class="btn-preview" onclick="abrirDanfe()">üëÅÔ∏è Visualizar DANFE</button>
    </header>

    <div class="upload-area" id="dropZone">
        <strong>Clique aqui para selecionar o XML</strong>
        <small style="color:#64748b">Vers√£o NF-e 4.00</small>
        <input type="file" accept=".xml" id="xmlFile">
    </div>

    <div class="info-card" id="headerInfo">
        <div class="info-grid">
            <div class="info-item"><label>CNPJ Emitente</label><span id="headCNPJ">--</span></div>
            <div class="info-item" style="grid-column: span 2"><label>Raz√£o Social</label><span id="headRazao">--</span></div>
            <div class="info-item"><label>N¬∫ Nota</label><span id="headNF">--</span></div>
            <div class="info-item"><label>Data Emiss√£o</label><span id="headData">--</span></div>
            <div class="info-item" style="grid-column: span 2"><label>Chave de Acesso</label><span id="headChave" style="font-family:monospace; letter-spacing:-0.5px">--</span></div>
        </div>
        <div class="info-divider"></div>
        <div class="info-grid">
            <div class="info-item"><label>Valor Total Nota</label><span id="headTotalNF">--</span></div>
            <div class="info-item"><label>Base de ICMS</label><span id="headBC">--</span></div>
            <div class="info-item"><label>Total IPI</label><span id="headIPI">--</span></div>
            <div class="info-item"><label>Outras / Frete</label><span id="headOutras">--</span></div>
        </div>
    </div>

    <div class="table-container" id="tableBox">
        <table>
            <thead>
                <tr>
                    <th>#</th><th style="text-align:left">Descri√ß√£o</th><th>NCM</th><th>V.Prod</th><th>IPI</th><th>Outras</th><th>% Orig</th><th>% Dest</th><th>ICMS Orig</th><th>ICMS SP</th><th>DIFAL</th>
                </tr>
            </thead>
            <tbody id="itens"></tbody>
        </table>
    </div>

    <div class="actions-bar" id="actionsBar">
        <div class="total-box"><small>A RECOLHER:</small> R$ <span id="totalGeral">0,00</span></div>
        <div class="btn-group">
            <button class="action-btn btn-excel" onclick="exportarExcel()">Excel</button>
            <button class="action-btn btn-pdf" onclick="salvarPDF()">PDF</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalDanfe">
    <div class="modal-content">
        <div class="modal-header">
            <strong>Pr√©-visualiza√ß√£o (Simula√ß√£o DANFE)</strong>
            <div>
                <button onclick="imprimirSeguro()" style="padding:5px 15px; cursor:pointer; background:#3b82f6; color:#fff; border:none; border-radius:4px; margin-right:10px;">üñ®Ô∏è Imprimir</button>
                <button class="close-btn" onclick="fecharDanfe()">&times;</button>
            </div>
        </div>
        <div class="danfe-wrapper" id="danfeContent"></div>
    </div>
</div>
<iframe id="printFrame" style="position:absolute; width:0; height:0; border:none; visibility:hidden;"></iframe>

<script>
// ================= UTIL =================
const fmt = v => v.toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
const numBR  = v => parseFloat((v||"0").replace(/\./g,"").replace(",",".")) || 0;
const numXML = v => parseFloat(v || 0);
let xmlDoc = null; 

// ================= UPLOAD CORRIGIDO =================
const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("xmlFile");

// 1. Clique na caixa aciona o input escondido
dropZone.addEventListener("click", () => fileInput.click());

// 2. Drag & Drop Visual
dropZone.addEventListener("dragover", (e) => { 
    e.preventDefault(); 
    dropZone.style.borderColor = "#3b82f6"; 
});
dropZone.addEventListener("dragleave", () => { 
    dropZone.style.borderColor = "#cbd5e1"; 
});
dropZone.addEventListener("drop", (e) => { 
    e.preventDefault(); 
    dropZone.style.borderColor = "#cbd5e1"; 
    if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); 
});

// 3. Sele√ß√£o via Input (Change)
fileInput.addEventListener("change", (e) => { 
    if(e.target.files.length) handleFile(e.target.files[0]); 
});

function handleFile(file) {
    if(file.type !== "text/xml") { alert("Use apenas arquivos XML."); return; }
    
    // IMPORTANTE: Reseta o input para permitir selecionar o mesmo arquivo novamente se necess√°rio
    fileInput.value = ""; 

    const reader = new FileReader();
    reader.onload = ev => {
        try {
            const text = ev.target.result.replace(/([a-zA-Z0-9]+):/g, ""); 
            xmlDoc = new DOMParser().parseFromString(text, "text/xml");
            if(xmlDoc.getElementsByTagName("parsererror").length > 0) throw new Error();
            carregarSistema(xmlDoc);
        } catch(err) { alert("Erro ao processar arquivo XML."); }
    };
    reader.readAsText(file);
}

function carregarSistema(xml) {
    document.getElementById("btnPreview").style.display = "flex";

    // Header Info
    const emit = xml.querySelector("emit");
    const ide = xml.querySelector("ide");
    const tot = xml.querySelector("ICMSTot");
    const inf = xml.querySelector("infNFe");

    const rz = emit?.querySelector("xNome")?.textContent || "";
    const cp = emit?.querySelector("CNPJ")?.textContent || "";
    const nn = ide?.querySelector("nNF")?.textContent || "";
    const ch = inf?.getAttribute("Id")?.replace("NFe","") || "";
    const dt = ide?.querySelector("dhEmi")?.textContent || ide?.querySelector("dEmi")?.textContent;
    const dataFmt = dt ? dt.substring(0,10).split("-").reverse().join("/") : "";

    document.getElementById("headRazao").innerText = rz;
    document.getElementById("headCNPJ").innerText = cp;
    document.getElementById("headNF").innerText = nn;
    document.getElementById("headChave").innerText = ch;
    document.getElementById("headData").innerText = dataFmt;

    // Totais Fiscais
    const vNF = numXML(tot?.querySelector("vNF")?.textContent);
    const vBC = numXML(tot?.querySelector("vBC")?.textContent);
    const vIPI = numXML(tot?.querySelector("vIPI")?.textContent);
    const vOutrasTotal = numXML(tot?.querySelector("vFrete")?.textContent) + numXML(tot?.querySelector("vSeg")?.textContent) + numXML(tot?.querySelector("vOutro")?.textContent);

    document.getElementById("headTotalNF").innerText = "R$ " + fmt(vNF);
    document.getElementById("headBC").innerText = "R$ " + fmt(vBC);
    document.getElementById("headIPI").innerText = "R$ " + fmt(vIPI);
    document.getElementById("headOutras").innerText = "R$ " + fmt(vOutrasTotal);

    document.getElementById("headerInfo").style.display = "block";

    // Itens
    const dets = xml.querySelectorAll("det");
    const tbody = document.getElementById("itens");
    tbody.innerHTML = "";
    let i = 1;
    dets.forEach(det => {
        const prod = det.querySelector("prod");
        if(!prod) return;
        
        const desc = prod.querySelector("xProd")?.textContent || "";
        const ncm = prod.querySelector("NCM")?.textContent || "";
        const vProd = numXML(prod.querySelector("vProd")?.textContent);
        
        // IPI
        let vIPIItem = 0;
        const ipiTag = det.querySelector("IPI > IPITrib") || det.querySelector("IPI > IPINT");
        if(ipiTag && ipiTag.querySelector("vIPI")) vIPIItem = numXML(ipiTag.querySelector("vIPI").textContent);

        // ICMS / BC
        let pICMS=0, vICMSST=0, vBCItem=0, vICMSItem=0;
        const icmsTag = det.querySelector("ICMS")?.firstElementChild;
        if(icmsTag) {
            pICMS = numXML(icmsTag.querySelector("pICMS")?.textContent);
            vBCItem = numXML(icmsTag.querySelector("vBC")?.textContent);
            vICMSItem = numXML(icmsTag.querySelector("vICMS")?.textContent);
            vICMSST = numXML(icmsTag.querySelector("vICMSST")?.textContent);
        }

        const outras = numXML(prod.querySelector("vFrete")?.textContent) + numXML(prod.querySelector("vSeg")?.textContent) + numXML(prod.querySelector("vOutro")?.textContent) + vICMSST;

        const row = `<tr id="tr${i}" data-vbc="${vBCItem}" data-vicms="${vICMSItem}" data-vprod-xml="${vProd}">
            <td>${i}</td><td class="left">${desc}</td><td>${ncm}</td>
            <td class="input-cell bg-edit"><input id="vp${i}" value="${fmt(vProd)}" onkeyup="calcular(${i})"></td>
            <td class="input-cell bg-edit"><input id="vi${i}" value="${fmt(vIPIItem)}" onkeyup="calcular(${i})"></td>
            <td class="input-cell bg-edit"><input id="od${i}" value="${fmt(outras)}" onkeyup="calcular(${i})"></td>
            <td class="input-cell bg-edit"><input id="ao${i}" value="${fmt(pICMS)}" onkeyup="calcular(${i})"></td>
            <td class="input-cell bg-edit"><input id="ad${i}" value="18,00" onkeyup="calcular(${i})"></td>
            <td id="io${i}" class="bg-calc">0,00</td><td id="is${i}" class="bg-calc">0,00</td><td id="df${i}" class="bg-res">0,00</td>
        </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
        calcular(i);
        i++;
    });
    document.getElementById("tableBox").style.display = "block";
    document.getElementById("actionsBar").style.display = "flex";
}

function calcular(i) {
    const vp = numBR(document.getElementById("vp"+i).value);
    const vi = numBR(document.getElementById("vi"+i).value);
    const od = numBR(document.getElementById("od"+i).value);
    const ao = numBR(document.getElementById("ao"+i).value)/100;
    const ad = numBR(document.getElementById("ad"+i).value)/100;

    const tr = document.getElementById("tr"+i);
    const xmlBC = parseFloat(tr.getAttribute("data-vbc") || 0);
    const xmlProd = parseFloat(tr.getAttribute("data-vprod-xml") || 0);
    const xmlICMS = parseFloat(tr.getAttribute("data-vicms") || 0);
    
    let icmsOrig = 0;
    const elOrig = document.getElementById("io"+i);

    if (xmlBC > xmlProd && xmlICMS > 0) {
        icmsOrig = xmlICMS;
        elOrig.classList.add("xml-rule-active");
        elOrig.title = "Valor fixo do XML (Base > Produto)";
    } else {
        icmsOrig = (vp + vi + od) * ao; 
        elOrig.classList.remove("xml-rule-active");
        elOrig.title = "";
    }

    let baseSP = 0, icmsSP = 0, difal = 0;
    if(ad > 0) {
        baseSP = (vp + vi + od - icmsOrig) / (1 - ad);
        icmsSP = baseSP * ad;
        difal = icmsSP - icmsOrig;
    }
    elOrig.innerText = fmt(icmsOrig);
    document.getElementById("is"+i).innerText = fmt(icmsSP);
    document.getElementById("df"+i).innerText = fmt(difal);
    atualizarTotal();
}

function atualizarTotal() {
    let total = 0;
    document.querySelectorAll('[id^="df"]').forEach(el => total += numBR(el.innerText));
    document.getElementById("totalGeral").innerText = fmt(total);
}

// ================= DANFE =================
function abrirDanfe() {
    if(!xmlDoc) return;
    const el = tag => xmlDoc.querySelector(tag)?.textContent || "";
    const getAttr = (tag, attr) => xmlDoc.querySelector(tag)?.getAttribute(attr) || "";
    const fmtData = d => d ? d.substring(0,10).split("-").reverse().join("/") : "";

    const chave = getAttr("infNFe", "Id").replace("NFe", "");
    const nNF = el("nNF"); const serie = el("serie");
    const emitNome = xmlDoc.querySelector("emit > xNome")?.textContent || "";
    const emitCNPJ = xmlDoc.querySelector("emit > CNPJ")?.textContent || "";
    const emitLgr = xmlDoc.querySelector("emit > enderEmit > xLgr")?.textContent || "";
    const emitNro = xmlDoc.querySelector("emit > enderEmit > nro")?.textContent || "";
    const emitMun = xmlDoc.querySelector("emit > enderEmit > xMun")?.textContent || "";
    const emitUF = xmlDoc.querySelector("emit > enderEmit > UF")?.textContent || "";
    const destNome = xmlDoc.querySelector("dest > xNome")?.textContent || "";
    const destCNPJ = xmlDoc.querySelector("dest > CNPJ")?.textContent || "";
    const destLgr = xmlDoc.querySelector("dest > enderDest > xLgr")?.textContent || "";
    const destNro = xmlDoc.querySelector("dest > enderDest > nro")?.textContent || "";
    const dEmi = fmtData(el("dhEmi") || el("dEmi"));
    const vBC = fmt(numXML(xmlDoc.querySelector("ICMSTot > vBC")?.textContent));
    const vICMS = fmt(numXML(xmlDoc.querySelector("ICMSTot > vICMS")?.textContent));
    const vProd = fmt(numXML(xmlDoc.querySelector("ICMSTot > vProd")?.textContent));
    const vNF = fmt(numXML(xmlDoc.querySelector("ICMSTot > vNF")?.textContent));
    const vIPI = fmt(numXML(xmlDoc.querySelector("ICMSTot > vIPI")?.textContent));

    let itens = "";
    xmlDoc.querySelectorAll("det").forEach(det => {
        const p = t => det.querySelector("prod > "+t)?.textContent||"";
        const f = v => fmt(numXML(v));
        let ipi = "0,00"; 
        const ipiTag = det.querySelector("IPI > IPITrib") || det.querySelector("IPI > IPINT");
        if(ipiTag) ipi = f(ipiTag.querySelector("vIPI")?.textContent);
        let icmsTag = det.querySelector("ICMS")?.firstElementChild;
        let vBCItem = f(icmsTag?.querySelector("vBC")?.textContent);
        let vICMSItem = f(icmsTag?.querySelector("vICMS")?.textContent);

        itens += `<tr>
            <td>${p("cProd")}</td><td>${p("xProd")}</td><td>${p("NCM")}</td>
            <td align="center">${p("CFOP")}</td><td align="center">${p("uCom")}</td>
            <td class="num">${f(p("qCom"))}</td><td class="num">${f(p("vUnCom"))}</td>
            <td class="num">${f(p("vProd"))}</td><td class="num">${vBCItem}</td>
            <td class="num">${vICMSItem}</td><td class="num">${ipi}</td>
        </tr>`;
    });

    const html = `
    <div class="danfe-box" style="display:flex; height:100px;">
        <div style="flex:1; padding:10px; border-right:1px solid #000;">
            <h3>${emitNome}</h3>
            <p>${emitLgr}, ${emitNro}<br>${emitMun}/${emitUF}<br>CNPJ: ${emitCNPJ}</p>
        </div>
        <div style="flex:1; padding:5px; text-align:center;">
            <h3>DANFE</h3>
            <p>N¬∫ ${nNF} - S√©rie ${serie}</p>
        </div>
        <div style="flex:2; padding:5px; word-break:break-all">
             <div class="danfe-label">CHAVE DE ACESSO</div>
             <div style="font-size:11px; font-weight:bold;">${chave}</div>
        </div>
    </div>
    <div class="danfe-title">DESTINAT√ÅRIO</div>
    <div class="danfe-box">
        <div class="danfe-row">
            <div class="danfe-col danfe-col-3"><div class="danfe-label">NOME</div><div class="danfe-val">${destNome}</div></div>
            <div class="danfe-col"><div class="danfe-label">CNPJ</div><div class="danfe-val">${destCNPJ}</div></div>
            <div class="danfe-col"><div class="danfe-label">DATA EMISS√ÉO</div><div class="danfe-val">${dEmi}</div></div>
        </div>
        <div class="danfe-row">
            <div class="danfe-col"><div class="danfe-label">ENDERE√áO</div><div class="danfe-val">${destLgr}, ${destNro}</div></div>
        </div>
    </div>
    <div class="danfe-title">C√ÅLCULO DO IMPOSTO</div>
    <div class="danfe-box">
        <div class="danfe-row">
            <div class="danfe-col"><div class="danfe-label">BC ICMS</div><div class="danfe-val num">${vBC}</div></div>
            <div class="danfe-col"><div class="danfe-label">V. ICMS</div><div class="danfe-val num">${vICMS}</div></div>
            <div class="danfe-col"><div class="danfe-label">V. PROD</div><div class="danfe-val num">${vProd}</div></div>
            <div class="danfe-col"><div class="danfe-label">V. IPI</div><div class="danfe-val num">${vIPI}</div></div>
            <div class="danfe-col"><div class="danfe-label">V. TOTAL</div><div class="danfe-val num">${vNF}</div></div>
        </div>
    </div>
    <div class="danfe-title">ITENS</div>
    <table class="danfe-table">
        <thead><tr><th>COD</th><th>DESC</th><th>NCM</th><th>CFOP</th><th>UN</th><th>QTD</th><th>V.UN</th><th>V.TOT</th><th>BC.ICMS</th><th>V.ICMS</th><th>V.IPI</th></tr></thead>
        <tbody>${itens}</tbody>
    </table>
    `;

    document.getElementById("danfeContent").innerHTML = html;
    document.getElementById("modalDanfe").style.display = "flex";
}
function fecharDanfe() { document.getElementById("modalDanfe").style.display = "none"; }
function imprimirSeguro() {
    const conteudo = document.getElementById("danfeContent").innerHTML;
    const styleMain = document.getElementById("main-styles").innerText;
    const iframe = document.getElementById("printFrame");
    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(`<html><head><title>DANFE</title><style>${styleMain}</style><style>body{background:#fff;padding:0;margin:0}@media print{@page{margin:10mm}}</style></head><body><div class="danfe-wrapper">${conteudo}</div></body></html>`);
    doc.close();
    setTimeout(() => { iframe.contentWindow.focus(); iframe.contentWindow.print(); }, 500);
}

// ================= EXPORT =================
function getNomeArquivo() {
    const razao = document.getElementById("headRazao").innerText.replace(/[^a-zA-Z0-9 ]/g, "").trim();
    const nf = document.getElementById("headNF").innerText.trim();
    return `Difal ${razao} NF ${nf}`;
}
function exportarExcel() {
    const dados = [];
    dados.push(["Item", "Descri√ß√£o", "NCM", "Valor Produto", "IPI", "Outras Desp.", "% Origem", "% Destino", "ICMS Origem", "ICMS Destino", "DIFAL a Pagar"]);
    document.querySelectorAll("#itens tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        const getVal = idx => tds[idx].querySelector("input") ? tds[idx].querySelector("input").value : tds[idx].innerText;
        const clean = v => parseFloat(v.replace(/\./g,"").replace(",","."));
        if(clean(tds[10].innerText) !== 0) {
            dados.push([tds[0].innerText, tds[1].innerText, tds[2].innerText, clean(getVal(3)), clean(getVal(4)), clean(getVal(5)), clean(getVal(6)), clean(getVal(7)), clean(tds[8].innerText), clean(tds[9].innerText), clean(tds[10].innerText)]);
        }
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(dados);
    ws['!cols'] = [{wch: 5}, {wch: 40}, {wch: 10}, {wch: 12}, {wch: 10}, {wch: 10}, {wch: 8}, {wch: 8}, {wch: 12}, {wch: 12}, {wch: 15}];
    XLSX.utils.book_append_sheet(wb, ws, "DIFAL SP");
    XLSX.writeFile(wb, getNomeArquivo() + ".xlsx");
}

function salvarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("l", "mm", "a4");
    doc.setFontSize(14); doc.setFont("helvetica", "bold"); doc.text("Relat√≥rio de C√°lculo - DIFAL SP (Base Dupla)", 14, 15);
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold"); doc.text("EMITENTE:", 14, 25);
    doc.setFont("helvetica", "normal"); doc.text(`${document.getElementById("headRazao").innerText} (${document.getElementById("headCNPJ").innerText})`, 35, 25);
    doc.setFont("helvetica", "bold"); doc.text("NOTA FISCAL:", 14, 30);
    doc.setFont("helvetica", "normal"); doc.text(`${document.getElementById("headNF").innerText}  |  Emiss√£o: ${document.getElementById("headData").innerText}`, 38, 30);
    doc.setFont("helvetica", "bold"); doc.text("CHAVE:", 14, 35);
    doc.setFont("helvetica", "normal"); doc.text(document.getElementById("headChave").innerText, 28, 35);
    doc.setFillColor(240, 240, 240); doc.rect(14, 39, 270, 8, "F");
    doc.setFont("helvetica", "bold");
    doc.text(`Total Nota: ${document.getElementById("headTotalNF").innerText}`, 16, 44);
    doc.text(`Base ICMS: ${document.getElementById("headBC").innerText}`, 70, 44);
    doc.text(`Total IPI: ${document.getElementById("headIPI").innerText}`, 130, 44);
    doc.text(`Outras/Frete: ${document.getElementById("headOutras").innerText}`, 180, 44);

    const rows = [];
    document.querySelectorAll("#itens tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        if(tds[10].innerText === "0,00") return;
        const getVal = idx => tds[idx].querySelector("input") ? tds[idx].querySelector("input").value : tds[idx].innerText;
        rows.push([tds[0].innerText, tds[1].innerText, tds[2].innerText, getVal(3), getVal(4), getVal(6)+"%", getVal(7)+"%", tds[8].innerText, tds[9].innerText, tds[10].innerText]);
    });
    doc.autoTable({ startY: 50, head: [['#', 'Produto', 'NCM', 'V. Prod', 'IPI', '% Orig', '% SP', 'ICMS Orig', 'ICMS SP', 'DIFAL']], body: rows, theme: 'striped', headStyles: { fillColor: [26, 59, 92] }, styles: { fontSize: 8 }, columnStyles: { 0: {cellWidth: 8}, 1: {cellWidth: 60} } });
    doc.setFont("helvetica", "bold"); doc.setFontSize(11);
    doc.text(`TOTAL A PAGAR: R$ ${document.getElementById("totalGeral").innerText}`, 280, doc.lastAutoTable.finalY + 10, {align: "right"});
    doc.save(getNomeArquivo() + ".pdf");
}
</script>
</body>
</html>
